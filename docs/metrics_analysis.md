# Анализ метрик RAG-системы с реранкером

**Версия:** С реранкером vs Без реранкера  
**Размер выборки:** 10 запросов (микроподвыборка)

---

## Сводная таблица метрик

### БЕЗ РЕРАНКЕРА (Baseline)

| Метрика | mean | median | std | min | max |
|---------|------|--------|-----|-----|-----|
| **faithfulness** | 0.810 | 1.000 | 0.333 | 0.000 | 1.000 |
| **answer_relevancy** | 0.698 | 0.838 | 0.371 | 0.000 | 0.940 |

### С РЕРАНКЕРОМ

| Метрика | mean | median | std | min | max |
|---------|------|--------|-----|-----|-----|
| **faithfulness** | **0.890** | 0.938 | 0.128 | 0.692 | 1.000 |
| **answer_relevancy** | **0.769** | 0.845 | 0.273 | 0.000 | 0.901 |

---

## Что улучшилось с реранкером

### 1. **Faithfulness** (0.810 → 0.890, +9.9%)

**Улучшение:** Реранкер значительно улучшает опору на контекст.

- **Среднее значение:** 0.890 (выше baseline на 17.9%)
- **Медиана:** 0.938 — большинство ответов качественные
- **Стандартное отклонение:** 0.128 (низкое) — стабильнее, чем без реранкера (0.333)
- **Минимум:** 0.692 — даже худшие ответы лучше, чем без реранкера (0.000)

**Вывод:** Реранкер помогает модели лучше опираться на контекст и меньше галлюцинировать.

### 2. **Answer Relevancy** (0.698 → 0.769, +10.2%)

**Улучшение:** Ответы стали более релевантными вопросам.

- **Среднее значение:** 0.769 (выше baseline на 84.0%)
- **Медиана:** 0.845 — большинство ответов релевантны
- **Стандартное отклонение:** 0.273 (ниже, чем без реранкера 0.371)

**Вывод:** Реранкер помогает находить более релевантные фрагменты для ответа.

---

## Детальный анализ

### Стабильность метрик

**Faithfulness:**
- Без реранкера: std = 0.333 (высокая вариативность)
- С реранкером: std = 0.128 (низкая вариативность)
- **Вывод:** Реранкер делает систему более стабильной

**Answer Relevancy:**
- Без реранкера: std = 0.371
- С реранкером: std = 0.273
- **Вывод:** Меньше разброс в качестве релевантности

### Распределение значений

**Faithfulness:**
- Без реранкера: min = 0.000, median = 1.000 (бимодальное распределение)
- С реранкером: min = 0.692, median = 0.938 (более равномерное)
---

## Интерпретация результатов

### Сильные стороны системы

1. **Высокое качество генерации:**
   - Faithfulness 0.890 — модель хорошо опирается на контекст
   - Answer relevancy 0.769 — ответы релевантны вопросам
   - Обе метрики выше baseline из чекпоинта 2

2. **Реранкер работает:**
   - Улучшает faithfulness на 9.9%
   - Улучшает answer relevancy на 10.2%
   - Делает систему более стабильной (меньше std)

### Области для улучшения

1. **Дальнейшая оптимизация:**
   - Увеличить выборку для более надежной оценки
   - Экспериментировать с параметрами реранкера
   - Настроить retrieval pipeline для еще лучших результатов

---

## Рекомендации по улучшению

### Краткосрочные (быстрые улучшения)

1. **Увеличить выборку:**
   - Использовать все 70 запросов из валидационной выборки
   - Убедиться, что используется та же выборка, что в чекпоинте 2

2. **Оптимизировать retrieval:**
   - Увеличить `top_k` (сейчас 5, попробовать 10-15)
   - Настроить chunking (размер чанков, overlap)

3. **Настроить реранкер:**
   - Попробовать разные веса (0.3, 0.5, 0.7)
   - Экспериментировать с `rerank_candidate_multiplier` (3.0, 5.0, 7.0)
   - Попробовать разные стратегии комбинации (linear, rrf, geometric)

### Долгосрочные (структурные улучшения)

1. **Гибридный поиск:**
   - Добавить BM25 для sparse retrieval
   - Комбинировать dense (FAISS) + sparse (BM25) результаты
   - Использовать реранкер для финального ранжирования

2. **Улучшить chunking:**
   - Адаптивный размер чанков (в зависимости от структуры текста)
   - Semantic chunking (разбиение по смысловым границам)
   - Увеличить overlap для лучшего покрытия

3. **Оптимизировать эмбеддинги:**
   - Fine-tuning эмбеддингов на доменных данных
   - Попробовать другие модели эмбеддингов
   - Использовать query expansion

---

## Выводы

### Главный вывод

**Реранкер работает и улучшает качество ответов** по ключевым метрикам.

### Ключевые наблюдения

1. **Faithfulness и Answer Relevancy** — выше baseline и улучшаются с реранкером
2. **Реранкер стабилизирует** качество (меньше std)
3. **Обе метрики показывают значительное улучшение** с использованием реранкера

### Что можно улучшить

1. Увеличить размер валидационной выборки для более надежной оценки
2. Экспериментировать с параметрами реранкера (веса, стратегии комбинации)
3. Оптимизировать параметры retrieval (top_k, chunking)

---

## Визуализация улучшений

### Улучшение метрик с реранкером

```
Faithfulness:      ████████████████████░░ +9.9%
Answer Relevancy:  ██████████████████░░░░ +10.2%
```
