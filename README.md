# RAG Чат-бот по роману "Мастер и Маргарита"

Проект для курса "Введение в LLM" - система ответов на вопросы по роману М.А. Булгакова с использованием RAG.

## Источник данных

**Книга**: Михаил Булгаков - "Мастер и Маргарита"

**Источник**: [Флибуста](https://flibusta.is/b/813954) (формат FB2)

**Расположение**: `data/master_and_margarita.fb2` (включена в репозиторий)

## Быстрый старт

### 1. Создание виртуального окружения
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
venv\Scripts\activate     # Windows
```

### 2. Установка зависимостей
```bash
pip install -r requirements.txt
```

### 3. Настройка переменных окружения
Создайте файл `.env`:
```
CLAUDE_API_KEY=ваш_ключ_claude
GIGACHAT_AUTH_KEY=ваш_ключ_gigachat
```

### 4. Подготовка данных
```bash
python prepare_data.py
```

### 5. Запуск приложения
```bash
streamlit run frontend/app.py
```

Приложение будет доступно по адресу: http://localhost:8501

## Запуск через Docker (альтернативный вариант)

```bash
# Подготовка данных
docker-compose --profile init run --rm data-init

# Запуск приложения
docker-compose up frontend
```

## Структура данных

Все данные хранятся в папке `data/`:

```
data/
├── master_and_margarita.fb2   # Исходная книга (3.7 MB)
├── chunks.json                # Чанки текста с метаданными (42 MB)
└── faiss_index/
    └── index.faiss            # Векторный индекс FAISS (37 MB)
```

### Формат chunks.json

```json
[
  {
    "id": 0,
    "text": "Однажды весною, в час небывало жаркого заката...",
    "chapter": 1,
    "start_char": 0,
    "end_char": 500
  }
]
```

Каждый чанк содержит:
- `id` - уникальный идентификатор
- `text` - текст фрагмента
- `chapter` - номер главы (1-32 + эпилог)
- `start_char`, `end_char` - позиция в исходном тексте

## Сбор и подготовка данных

### Процесс обработки

1. **Парсинг FB2** - извлечение текста из XML-структуры
2. **Разбиение на главы** - определение границ глав по заголовкам
3. **Chunking** - разбиение на фрагменты ~300 символов с перекрытием 30
4. **Эмбеддинги** - создание векторных представлений через GigaChat
5. **Индексация** - построение FAISS индекса для быстрого поиска

### Параметры

| Параметр | Значение |
|----------|----------|
| Размер чанка | ~300 символов |
| Перекрытие | 30 символов |
| Эмбеддер | GigaChatEmbeddings |
| Размерность вектора | 1024 |
| Тип индекса | FAISS IndexFlatL2 |

**Почему GigaChatEmbeddings?** Облачный API удобнее для запуска на ноутбуке - локальные эмбеддеры требуют много памяти и GPU.

### Объем данных

| Метрика | Значение |
|---------|----------|
| Исходный текст | ~580 000 символов |
| Количество глав | 32 + эпилог |
| Количество чанков | 9 358 |
| Размер chunks.json | 42 MB |
| Размер FAISS индекса | 37 MB |

## Структура проекта

```
.
├── services/
│   ├── data_service/
│   │   ├── data_processor.py   # Парсинг FB2 и chunking
│   │   └── download_book.py    # Проверка наличия книги
│   ├── rag_service/
│   │   └── rag_engine.py       # Эмбеддинги и FAISS
│   └── llm_service/
│       └── claude_client.py    # Клиент Claude API
├── frontend/
│   └── app.py                  # Streamlit интерфейс
├── data/                       # Данные (книга, чанки, индекс)
├── prepare_data.py             # Скрипт подготовки данных
├── requirements.txt
├── Dockerfile
├── docker-compose.yml
└── .env.example
```

## Сэмпл данных

Пример чанков из `data/chunks.json`:

**Чанк из главы 1:**
```
Однажды весною, в час небывало жаркого заката, в Москве, на Патриарших
прудах, появились два гражданина. Первый из них, одетый в летнюю серенькую
пару, был маленького роста, упитан, лыс...
```

**Чанк из главы 13:**
```
Маргарита Николаевна со своим мужем вдвоем занимали весь верх прекрасного
особняка в саду в одном из переулков близ Арбата. Очаровательное место!
```

## Технологии

- Python 3.10
- FAISS (векторный поиск)
- GigaChat Embeddings (langchain-gigachat)
- Claude API (генерация ответов)
- Streamlit (веб-интерфейс)
- Docker
